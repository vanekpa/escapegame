<!DOCTYPE html>
<html lang="cs" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Úniková hra - Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'fredoka': ['Fredoka', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%;
            min-height: 100vh;
            box-sizing: border-box;
            font-family: 'Fredoka', sans-serif;
        }

        .game-root {
            min-height: 100vh;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px 16px;
            overflow: hidden;
        }

        /* === DÁVKA 3: DESIGN SYSTÉM === */
        :root {
            /* Barvy */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            
            --success-400: #4ade80;
            --success-500: #22c55e;
            --success-600: #16a34a;
            
            --danger-400: #f87171;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            
            --warning-400: #fbbf24;
            --warning-500: #f59e0b;
            
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            /* Stíny */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Rozměry */
            --touch-target: 44px;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
        }

        /* Gradient pozadí */
        .game-background {
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 25%, 
                #f093fb 50%, 
                #f5576c 75%, 
                #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Info bubble */
        .info-bubble {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Progress rail */
        .progress-rail {
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(6px);
            border-radius: var(--border-radius-lg);
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }

        .progress-track {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            width: 100%;
            min-width: 0;
        }

        .progress-track::-webkit-scrollbar {
            display: none;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.45);
            background: rgba(255, 255, 255, 0.3);
            color: var(--neutral-900);
            flex: 0 0 auto;
            cursor: pointer;
        }

        .progress-step:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgb(14 165 233 / 0.35);
        }

        .progress-step:disabled {
            opacity: 0.45;
            cursor: default;
            transform: none;
            box-shadow: none;
        }

        .progress-step.progress-step--story,
        .progress-step.progress-step--default {
            background: rgba(255, 255, 255, 0.3);
        }

        .progress-step.progress-step--win {
            background: rgba(34, 197, 94, 0.35);
            color: var(--success-700);
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .progress-step.progress-step--lose {
            background: rgba(248, 113, 113, 0.35);
            color: var(--danger-600);
            border: 1px solid rgba(248, 113, 113, 0.4);
        }

        .progress-step.completed {
            background: var(--success-500);
            color: white;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.28);
        }

        .progress-step.current {
            background: var(--primary-500);
            color: white;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.28);
            animation: pulse 2s infinite;
        }

        .progress-step.visited {
            background: rgba(255, 255, 255, 0.6);
            color: var(--neutral-800);
        }

        .progress-step.locked {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
        }

        .progress-step.failed {
            background: var(--danger-500);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Unifikované vstupy */
        .ui-field {
            margin-bottom: 1.5rem;
        }

        .ui-label {
            display: block;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .ui-input {
            width: 100%;
            min-height: var(--touch-target);
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
        }

        .ui-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .ui-input:invalid {
            border-color: var(--danger-400);
        }

        .ui-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .ui-btn {
            min-height: var(--touch-target);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-family: inherit;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            user-select: none;
        }

        .ui-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ui-btn.primary {
            background: var(--primary-500);
            color: white;
        }

        .ui-btn.primary:hover:not(:disabled) {
            background: var(--primary-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .ui-btn.success {
            background: var(--success-500);
            color: white;
        }

        .ui-btn.success:hover:not(:disabled) {
            background: var(--success-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .ui-btn.danger {
            background: var(--danger-500);
            color: white;
        }

        .ui-btn.danger:hover:not(:disabled) {
            background: var(--danger-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .ui-btn.secondary {
            background: var(--neutral-100);
            color: var(--neutral-700);
            border: 1px solid var(--neutral-200);
        }

        .ui-btn.secondary:hover:not(:disabled) {
            background: var(--neutral-200);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Kulaté sloty/klávesy */
        .key-slot {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 3px solid var(--neutral-300);
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .key-slot:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-400);
        }

        .key-slot.filled {
            background: var(--success-500);
            color: white;
            border-color: var(--success-600);
        }

        .key-slot.error {
            background: var(--danger-500);
            color: white;
            border-color: var(--danger-600);
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Scene container */
        .scene-container {
            position: relative;
            width: 100%;
            flex: 1;
            min-height: 0;
            border-radius: var(--border-radius);
            display: flex;
            overflow: hidden;
        }

        .scene-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        .scene-content {
            position: relative;
            z-index: 2;
            width: 100%;
            display: grid;
            grid-template-rows: auto minmax(0, 1fr) auto;
            min-height: 100%;
        }

        .scene-header {
            padding: clamp(12px, 2vw, 24px);
        }

        .scene-main {
            padding: clamp(18px, 3vw, 36px);
            display: flex;
            justify-content: center;
            align-items: stretch;
            overflow: hidden;
            min-height: 0;
        }

        .scene-main-inner {
            flex: 1 1 auto;
            max-width: min(1160px, 100%);
            display: flex;
            flex-direction: column;
            gap: clamp(16px, 2vw, 28px);
            min-height: 0;
            overflow: hidden;
        }

        /* Background carousel */
        .background-carousel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .background-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            /* Fallback gradient pokud se obrázek nenačte */
            background-color: #667eea;
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .background-slide.active {
            opacity: 1;
        }



        /* === DÁVKA 5: TEXT ZOOM === */
        .text-zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius-sm);
        }

        /* === DÁVKA 6: MAGNIFIER === */
        .magnifier-container {
            position: relative;
            display: inline-block;
            cursor: crosshair;
            overflow: hidden;
            border-radius: var(--border-radius);
        }

        .magnifier-image {
            display: block;
            width: 100%;
            height: auto;
            user-select: none;
            -webkit-user-drag: none;
        }

        .magnifier-lens {
            position: absolute;
            width: 140px;
            height: 140px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            display: none;
            z-index: 10;
        }

        .magnifier-result {
            position: absolute;
            right: 12px;
            bottom: 12px;
            width: 180px;
            height: 180px;
            overflow: hidden;
            border-radius: 12px;
            background: #111;
            border: 3px solid #fff;
            display: none;
            z-index: 20;
            pointer-events: none;
        }

        .magnifier-result img {
            position: absolute;
            pointer-events: none;
        }

        @media (hover: none), (pointer: coarse) {
            .magnifier-container {
                cursor: default;
            }

            .magnifier-lens,
            .magnifier-result {
                display: none !important;
            }
        }

        .zoomable-scene-image {
            max-width: 100%;
            height: auto;
            max-height: 45vh;
            object-fit: contain;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
        }
        
        @media (max-width: 768px) {
            .zoomable-scene-image { 
                max-height: 35vh; 
            }
        }

        /* === DÁVKA 7-9: COMPLETE LOCK SYSTEM STYLES === */
        .lock-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: min(100%, 560px);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 1.5vw, 20px);
        }

        /* Numeric Lock Slots */
        .numeric-slots-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .numeric-slot {
            width: 60px;
            height: 60px;
            border: 3px solid var(--neutral-300);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .numeric-slot:hover {
            border-color: var(--primary-400);
            transform: translateY(-1px);
        }

        .numeric-slot.selected {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .numeric-slot.correct {
            border-color: var(--success-500);
            background: rgba(34, 197, 94, 0.1);
        }

        .numeric-slot.incorrect {
            border-color: var(--danger-500);
            background: rgba(239, 68, 68, 0.1);
            animation: shake 0.5s ease-in-out;
        }

        .slot-content {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neutral-700);
        }

        /* Sequence Slots (Arrows, Colors, Shapes) */
        .sequence-slots-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .sequence-slot {
            width: 60px;
            height: 60px;
            border: 3px solid var(--neutral-300);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .sequence-slot:hover {
            border-color: var(--primary-400);
            transform: translateY(-1px);
        }

        .sequence-slot.selected {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .sequence-slot.correct {
            border-color: var(--success-500);
            background: rgba(34, 197, 94, 0.1);
        }

        .sequence-slot.incorrect {
            border-color: var(--danger-500);
            background: rgba(239, 68, 68, 0.1);
            animation: shake 0.5s ease-in-out;
        }

        /* Color Slots */
        .color-slot .color-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--neutral-300);
            background: var(--neutral-100);
        }

        .color-slot .color-name {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--neutral-600);
        }

        /* Shape Slots */
        .shape-slot .shape-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--neutral-600);
        }

        /* Soft Keyboards */
        .soft-keyboard {
            margin: clamp(14px, 2vw, 22px) 0 0;
            padding: clamp(14px, 2vw, 22px);
            background: linear-gradient(165deg, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.92));
            border-radius: var(--border-radius);
            box-shadow: 0 18px 40px -20px rgba(15, 23, 42, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(8px);
            display: grid;
            gap: clamp(10px, 1.6vw, 18px);
            width: 100%;
            max-width: none;
        }

        .keyboard-grid {
            display: grid;
            gap: clamp(10px, 1.6vw, 18px);
            width: 100%;
            grid-auto-rows: minmax(52px, auto);
            justify-items: stretch;
        }

        .keyboard-key {
            position: relative;
            min-width: 48px;
            min-height: 48px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(226, 232, 240, 0.96));
            box-shadow: 0 10px 25px -18px rgba(15, 23, 42, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--neutral-700);
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 0.75rem;
        }

        .keyboard-key:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 24px -16px rgba(14, 165, 233, 0.55);
            border-color: rgba(14, 165, 233, 0.45);
            background: linear-gradient(180deg, rgba(255, 255, 255, 1), rgba(224, 242, 254, 0.95));
        }

        .keyboard-key:active {
            transform: translateY(0);
            box-shadow: inset 0 1px 4px rgba(15, 23, 42, 0.2);
        }

        .keyboard-key.backspace-key {
            background: linear-gradient(180deg, rgba(254, 242, 242, 0.96), rgba(254, 226, 226, 0.9));
            border-color: rgba(248, 113, 113, 0.45);
            color: var(--danger-600);
        }

        .keyboard-key.backspace-key:hover {
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 0 14px 28px -18px rgba(248, 113, 113, 0.65);
            background: linear-gradient(180deg, rgba(254, 242, 242, 1), rgba(254, 215, 215, 0.95));
        }

        .keyboard-key.wide-key {
            grid-column: 1 / -1;
            justify-self: center;
            min-width: min(220px, 100%);
        }

        /* Arrow Keys */
        .arrow-key {
            font-size: 1.5rem;
        }

        .numeric-keyboard .keyboard-grid {
            grid-template-columns: repeat(3, minmax(64px, 1fr));
            justify-items: stretch;
        }

        .numeric-keyboard .keyboard-grid .keyboard-key {
            min-height: 56px;
        }

        .numeric-keyboard .keyboard-grid .keyboard-key.zero-key {
            grid-column: span 2;
        }

        .numeric-keyboard .keyboard-grid .backspace-key {
            align-self: stretch;
        }

        .arrow-keyboard .keyboard-grid {
            grid-template-columns: repeat(3, minmax(60px, 1fr));
            grid-template-rows: repeat(3, minmax(56px, auto)) minmax(56px, auto);
            grid-template-areas:
                ". up ."
                "left . right"
                ". down ."
                "wide wide wide";
            justify-items: stretch;
        }

        .arrow-keyboard .arrow-key {
            aspect-ratio: 1 / 1;
            font-size: 1.5rem;
        }

        .arrow-keyboard .arrow-up {
            grid-area: up;
        }

        .arrow-keyboard .arrow-left {
            grid-area: left;
        }

        .arrow-keyboard .arrow-right {
            grid-area: right;
        }

        .arrow-keyboard .arrow-down {
            grid-area: down;
        }

        .arrow-keyboard .wide-key {
            grid-area: wide;
            max-width: none;
            justify-self: stretch;
            min-width: 0;
        }

        .color-keyboard,
        .shape-keyboard {
            grid-template-columns: repeat(auto-fit, minmax(64px, 1fr));
            justify-items: stretch;
            grid-auto-flow: dense;
        }

        .color-keyboard .keyboard-grid,
        .shape-keyboard .keyboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(64px, 1fr));
            width: 100%;
        }

        .color-keyboard .keyboard-grid .keyboard-key,
        .shape-keyboard .keyboard-grid .keyboard-key {
            aspect-ratio: 1 / 1;
        }

        /* Color Keys */
        .color-key {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Shape Keys */
        .shape-key {
            width: 50px;
            height: 50px;
        }

        .shape-key svg {
            color: var(--neutral-600);
        }

        .shape-key:hover svg {
            color: var(--primary-600);
        }

        /* Lock Feedback */
        .lock-feedback {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            text-align: center;
        }

        .lock-feedback.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-600);
            border: 1px solid var(--success-200);
        }

        .lock-feedback.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-600);
            border: 1px solid var(--danger-200);
        }

        .lock-feedback.info {
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-600);
            border: 1px solid var(--primary-200);
        }

        /* === DÁVKA 12: A11Y & QOL STYLES === */
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .magnifier-lens,
            .magnifier-result {
                transition: none !important;
            }
            
            .background-slide {
                transition: none !important;
            }
            
            .cryptex-char {
                transition: none !important;
            }
        }

        /* Enhanced mobile touch targets */
        @media (max-width: 768px) {
            .ui-btn {
                min-height: 48px;
                padding: 0.875rem 1.5rem;
                font-size: 1rem;
            }
            
            .keyboard-key {
                min-width: 48px;
                min-height: 48px;
                font-size: 1.125rem;
            }
            
            .numeric-slot,
            .sequence-slot {
                width: 64px;
                height: 64px;
                font-size: 1.375rem;
            }
            
            .cryptex-arrow {
                width: 48px;
                height: 36px;
                font-size: 1.125rem;
            }
            
            .cryptex-wheel {
                width: 64px;
                height: 64px;
            }
            
            .text-zoom-btn {
                min-width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        /* Touch action optimization */
        .keyboard-key,
        .ui-btn,
        .numeric-slot,
        .sequence-slot,
        .cryptex-arrow,
        .text-zoom-btn {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Focus indicators for keyboard navigation */
        .keyboard-key:focus,
        .ui-btn:focus,
        .numeric-slot:focus,
        .sequence-slot:focus,
        .cryptex-arrow:focus,
        .text-zoom-btn:focus {
            outline: 3px solid var(--primary-400);
            outline-offset: 2px;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Live region for announcements */
        .live-region {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* layout „obrázek nad zámkem" – dynamická mřížka */
        .content-stack {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: minmax(0, 2fr) minmax(220px, 1fr);
            gap: clamp(16px, 2vw, 24px);
            min-height: 0;
            height: 100%;
            align-items: stretch;
        }

        .content-stack__visual,
        .content-stack__panel {
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 1.5vw, 18px);
            overflow: hidden;
        }

        .content-stack__panel {
            overflow: auto;
        }

        .content-stack__visual:empty {
            display: none;
        }

        .content-stack__visual:empty + .content-stack__panel {
            grid-row: 1 / -1;
        }

        @media (min-width: 768px) {
            .content-stack {
                grid-template-rows: minmax(0, 1.75fr) minmax(240px, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .content-stack {
                grid-template-columns: minmax(0, 1.4fr) minmax(320px, 0.9fr);
                grid-template-rows: minmax(0, 1fr);
            }
        }

        /* puzzle bublina: obrázek vyplní dostupnou výšku */
        .puzzle-bubble {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .puzzle-bubble .puzzle-body {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .puzzle-bubble .magnifier-container {
            position: relative;
            height: 100%;
        }

        .puzzle-bubble .zoomable-scene-image {
            width: 100%;
            height: 100%;
            max-height: none;
            object-fit: contain;
        }

        /* rozbalovací sekce obrázku */
        .puzzle-body.collapsed { 
            display: none; 
        }

        /* aby se výsledek lupy nedostal mimo kontejner a nelezl do textu */
        .magnifier-container { 
            position: relative; 
        }
        
        .magnifier-result { 
            right: 12px; 
            bottom: 12px; 
            left: auto; 
            top: auto; 
        }

        /* ať je zámek viditelný i když je obsah dlouhý */
        .lock-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            flex: 1;
            min-height: 0;
            overflow: auto;
        }

        .content-stack__panel .lock-container {
            max-width: none;
            height: 100%;
            margin: 0;
        }

        .content-stack__panel .soft-keyboard {
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
        }

        /* víc tvarů do řady na desktopu */
        .shape-keyboard .keyboard-grid { 
            grid-template-columns: repeat(6, 1fr); 
            max-width: 480px; 
        }

        /* barvy v pevné mřížce */
        .color-keyboard .keyboard-grid { 
            grid-template-columns: repeat(5, 1fr); 
            max-width: 320px; 
        }

        @media (max-width: 768px) {
            .shape-keyboard .keyboard-grid { 
                grid-template-columns: repeat(3, 1fr); 
                max-width: 220px; 
            }
            
            .color-keyboard .keyboard-grid { 
                grid-template-columns: repeat(4, 1fr); 
                max-width: 260px; 
            }
        }

        /* === DÁVKA 10: CRYPTEX + QUIZ STYLES === */
        
        /* Cryptex Styles */
        .cryptex-wheels-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .cryptex-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .cryptex-arrow {
            width: 40px;
            height: 30px;
            border: 2px solid var(--neutral-300);
            border-radius: var(--border-radius-sm);
            background: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--neutral-600);
        }

        .cryptex-arrow:hover {
            border-color: var(--primary-400);
            background: var(--primary-50);
            color: var(--primary-600);
            transform: translateY(-1px);
        }

        .cryptex-arrow:active {
            transform: translateY(0);
        }

        .cryptex-wheel {
            width: 60px;
            height: 60px;
            border: 3px solid var(--neutral-400);
            border-radius: var(--border-radius-sm);
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .cryptex-char {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neutral-700);
            transition: all 0.3s ease;
            user-select: none;
        }

        .cryptex-wheel.correct {
            border-color: var(--success-500);
            background: linear-gradient(145deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.2));
        }

        .cryptex-wheel.incorrect {
            border-color: var(--danger-500);
            background: linear-gradient(145deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
            animation: shake 0.5s ease-in-out;
        }

        /* Quiz Styles */
        .quiz-progress {
            margin-bottom: 1.5rem;
        }

        .quiz-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--neutral-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .quiz-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .quiz-progress-text {
            text-align: center;
            font-size: 0.875rem;
            color: var(--neutral-600);
            font-weight: 600;
        }

        .quiz-questions {
            margin: 1.5rem 0;
        }

        .quiz-question {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius);
            background: white;
            transition: all 0.2s ease;
        }

        .quiz-question:hover {
            border-color: var(--primary-300);
            box-shadow: var(--shadow-sm);
        }

        .quiz-question.answered {
            border-color: var(--primary-400);
            background: rgba(14, 165, 233, 0.05);
        }

        .quiz-question.correct {
            border-color: var(--success-500);
            background: rgba(34, 197, 94, 0.05);
        }

        .quiz-question.incorrect {
            border-color: var(--danger-500);
            background: rgba(239, 68, 68, 0.05);
        }

        .quiz-question-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--neutral-800);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .quiz-answers {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .quiz-answer {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--neutral-200);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .quiz-answer:hover {
            border-color: var(--primary-300);
            background: var(--primary-50);
        }

        .quiz-answer input[type="radio"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .quiz-answer-text {
            flex: 1;
            font-size: 1rem;
            color: var(--neutral-700);
            line-height: 1.4;
        }

        .quiz-answer.selected {
            border-color: var(--primary-500);
            background: var(--primary-100);
        }

        .quiz-answer.correct-answer {
            border-color: var(--success-500);
            background: var(--success-50);
        }

        .quiz-answer.wrong-answer {
            border-color: var(--danger-500);
            background: var(--danger-50);
        }

        /* Legacy lock input styles for compatibility */
        .lock-input-grid {
            display: grid;
            gap: 0.5rem;
            margin: 1rem 0;
            justify-content: center;
        }

        .lock-input-grid.numeric {
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            max-width: 300px;
        }

        .lock-input-grid.text {
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            max-width: 400px;
        }

        .lock-input {
            width: 60px;
            height: 60px;
            border: 3px solid var(--neutral-300);
            border-radius: var(--border-radius-sm);
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            background: white;
            transition: all 0.2s ease;
        }

        .lock-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .lock-input.correct {
            border-color: var(--success-500);
            background: rgba(34, 197, 94, 0.1);
        }

        .lock-input.incorrect {
            border-color: var(--danger-500);
            background: rgba(239, 68, 68, 0.1);
            animation: shake 0.5s ease-in-out;
        }

        .text-zoom-label {
            font-size: 0.75rem;
            color: var(--neutral-600);
            font-weight: 500;
        }

        .text-zoom-btn {
            min-width: 32px;
            height: 32px;
            border: 1px solid var(--neutral-300);
            background: white;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .text-zoom-btn:hover {
            background: var(--neutral-50);
            border-color: var(--primary-400);
        }

        .text-zoom-btn.active {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-600);
        }

        /* Text size classes */
        .text-size-small {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .text-size-medium {
            font-size: 1rem;
            line-height: 1.5;
        }

        .text-size-large {
            font-size: 1.125rem;
            line-height: 1.6;
        }

        .text-size-xlarge {
            font-size: 1.25rem;
            line-height: 1.7;
        }

        /* InfoBubble enhanced */
        .info-bubble-content {
            transition: font-size 0.2s ease, line-height 0.2s ease;
        }

        .info-bubble-title {
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--neutral-800);
        }

        .info-bubble-text {
            color: var(--neutral-700);
            margin-bottom: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .ui-actions {
                flex-direction: column;
            }
            
            .ui-btn {
                width: 100%;
            }
            
            .progress-rail {
                padding: 0.75rem;
            }
            
            .progress-step {
                min-width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }

            .text-zoom-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body class="h-full game-background font-fredoka">
    <div id="root" class="game-root">
        <!-- Loading UI bude zde -->
    </div>
    
    <!-- Live region for screen reader announcements -->
    <div id="live-region" class="live-region" aria-live="polite" aria-atomic="true"></div>

    <script>
        // === DÁVKA 1: SKELETON + NAČTENÍ JSON ===
        
        class EscapeGameEngine {
            constructor() {
                this.gameData = null;
                this.normalizedData = null;
                this.pageIndex = new Map();
                this.preloadedImages = new Set();
                this.root = document.getElementById('root');
                this.liveRegion = document.getElementById('live-region');
                
                // interní registr aktivních lup
                this.magnifiers = new Map();
                
                // Dávka 2: Stav hry
                this.state = {
                    currentId: null,
                    solvedByStep: new Map(),
                    timeLeft: 0,
                    isRunning: false,
                    gameEnded: null, // 'win' | 'lose' | null
                    textSize: 'medium' // Dávka 5: Text zoom
                };
                
                this.timerInterval = null;
                this.carouselInterval = null;
                this.navSteps = [];
                
                // Dávka 12: Keyboard navigation
                this.setupKeyboardNavigation();
            }

            // Načtení JSON dat ze vzdálené URL
            async fetchGame(url) {
                try {
                    this.showLoading('Načítám data hry...');
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.gameData = data;
                    
                    return data;
                } catch (error) {
                    console.error('Chyba při načítání hry:', error);
                    this.showError(`Nepodařilo se načíst hru: ${error.message}`);
                    throw error;
                }
            }

            // Helper pro sběr URL obrázků z různých zdrojů
            collectImageUrls(...inputs) {
                const urls = [];
                const seenUrls = new Set();

                const visit = (value) => {
                    if (value == null) return;

                    if (Array.isArray(value)) {
                        value.forEach(visit);
                        return;
                    }

                    const url = this.extractImageUrl(value);
                    if (url && !seenUrls.has(url)) {
                        seenUrls.add(url);
                        urls.push(url);
                    }
                };

                inputs.forEach(visit);
                return urls;
            }

            // Vyřešení prvního dostupného obrázku ze zdrojů
            resolveImageSource(...inputs) {
                const [first] = this.collectImageUrls(...inputs);
                return first || null;
            }

            // Extrakce URL obrázku z různých formátů dat
            extractImageUrl(value, seenObjects = new Set()) {
                if (value == null) {
                    return null;
                }

                if (typeof value === 'string') {
                    const trimmed = value.trim();
                    return trimmed || null;
                }

                if (typeof value === 'object') {
                    if (seenObjects.has(value)) {
                        return null;
                    }

                    seenObjects.add(value);

                    const preferredKeys = ['url', 'src', 'image', 'image_url', 'imageUrl', 'href', 'desktop', 'mobile', 'tablet', 'default'];

                    for (const key of preferredKeys) {
                        if (value && Object.prototype.hasOwnProperty.call(value, key)) {
                            const found = this.extractImageUrl(value[key], seenObjects);
                            if (found) {
                                return found;
                            }
                        }
                    }

                    for (const nested of Object.values(value)) {
                        const found = this.extractImageUrl(nested, seenObjects);
                        if (found) {
                            return found;
                        }
                    }
                }

                return null;
            }

            // Normalizace dat - převod na konzistentní formát
            normalizeGame(data) {
                const sanitizeId = (value) => {
                    if (typeof value === 'string') {
                        const trimmed = value.trim();
                        return trimmed.length ? trimmed : null;
                    }
                    return value ?? null;
                };

                const sanitizeLabel = (value) => {
                    if (typeof value === 'string') {
                        const trimmed = value.trim();
                        return trimmed.length ? trimmed : null;
                    }
                    return null;
                };

                const mapLock = (lock, assets) => {
                    if (!lock) return null;
                    const mode = lock.mode;
                    const cfg = { mode, hint: lock.hint || '', assets };

                    switch (mode) {
                        case 'numeric': {
                            const seq = Array.isArray(lock.answer)
                                ? lock.answer.map(n => Number(n))
                                : String(lock.answer || '').split('').map(n => Number(n));
                            cfg.solution = { sequence: seq };
                            break;
                        }
                        case 'text': {
                            cfg.solution = {
                                word: String(lock.answer || ''),
                                case_sensitive: !!(lock.input && lock.input.case_sensitive)
                            };
                            break;
                        }
                        case 'arrows':
                        case 'colors':
                        case 'shapes': {
                            cfg.solution = { sequence: Array.isArray(lock.answer) ? lock.answer : [] };
                            if (mode === 'colors') {
                                const names = data.assets?.colors || [];
                                cfg.assets = {
                                    ...cfg.assets,
                                    colors: names.reduce((acc, n) => (acc[n]=acc[n]||n, acc), {})
                                };
                            }
                            if (mode === 'shapes') {
                                cfg.assets = { ...cfg.assets, shape_svgs: data.assets?.shape_svgs || {} };
                            }
                            break;
                        }
                        case 'cryptex': {
                            const word = Array.isArray(lock.answer) ? lock.answer.join('') : String(lock.answer||'');
                            cfg.solution = { word, case_sensitive: false };
                            cfg.assets = {
                                ...cfg.assets,
                                keyboards: { cryptex: { wheels: data.assets?.keyboards?.cryptex?.wheels || [] } }
                            };
                            break;
                        }
                        case 'quiz': {
                            // převezmi rovnou; engine používá questions[{question,answers[],correct_answer}]
                            const qs = (lock.questions || []).map(q => ({
                                question: q.text,
                                answers: q.answers.map(a => a.text),
                                correct_answer: q.answers.findIndex(a => a.correct)
                            }));
                            cfg.questions = qs;
                            cfg.pass_ratio = lock.pass_ratio ?? 0.8;
                            cfg.limit_draw = lock.limit ?? qs.length;
                            break;
                        }
                    }
                    return cfg;
                };

                const timer = data.meta?.timer
                    ? {
                        enabled: !!data.meta.timer.enabled,
                        duration_seconds: Number(data.meta.timer.seconds || 0),
                        warning_at: Number(data.meta.timer.warning_at || 0),
                        show: !!data.meta.timer.show,
                        lose_page: sanitizeId(data.meta.timer.lose_page || data.meta.timer.losePage || 'p-timeout')
                    }
                    : null;

                const normalized = {
                    meta: {
                        ...data.meta,
                        timer,
                        start_page: sanitizeId(data.meta?.start_page)
                    },
                    pages: data.pages.map(p => {
                        const type = p.type === 'info' ? 'story' : p.type;
                        const rawId = p.id != null ? String(p.id) : '';
                        const id = sanitizeId(rawId) || rawId;
                        const nextSuccess = sanitizeId(p.next_on_success);
                        const nextFail = sanitizeId(p.next_on_fail);

                        // Sběr obrázků z různých zdrojů
                        const elementImages = this.collectImageUrls((p.elements || []).map(element => [element.image_url, element.src, element.url]));
                        const uiSceneImages = this.collectImageUrls(p.ui?.scene_img);
                        const uiPuzzleImages = this.collectImageUrls(p.ui?.puzzle_img);
                        const uiBackgroundImages = this.collectImageUrls(p.ui?.background_imgs, p.ui?.background_img);
                        const pageBackgroundImages = this.collectImageUrls(p.background_imgs, p.background_img);

                        // Prioritizace pozadí podle typu stránky
                        const orderedBackgroundCandidates = type === 'story'
                            ? [...pageBackgroundImages, ...uiBackgroundImages, ...uiSceneImages]
                            : [...uiBackgroundImages, ...pageBackgroundImages, ...uiSceneImages];

                        let background_imgs = this.collectImageUrls(orderedBackgroundCandidates);

                        // Fallback pokud nemáme žádné pozadí
                        if (!background_imgs.length) {
                            background_imgs = this.collectImageUrls(uiPuzzleImages, elementImages, pageBackgroundImages);
                        }

                        // Určení hlavního scene obrázku pro magnifier/puzzle
                        const sceneImageCandidates = this.collectImageUrls(
                            uiSceneImages,
                            uiPuzzleImages,
                            background_imgs,
                            elementImages,
                            pageBackgroundImages
                        );

                        const scene_image = sceneImageCandidates[0] || null;
                        const progress_label = sanitizeLabel(p.progress_label || p.ui?.progress_label || '') || null;
                        
                        const title = p.info?.title || p.title || '';
                        const description = p.info?.text || p.info?.story || p.description || '';

                        return {
                            ...p,
                            id,
                            type,
                            title,
                            description,
                            background_imgs,
                            scene_image,
                            progress_label,
                            next_on_success: nextSuccess,
                            next_on_fail: nextFail,
                            // transformace zámku do engine formátu
                            lock: p.type === 'lock' ? mapLock(p.lock, data.assets || {}) : null
                        };
                    })
                };
                
                this.normalizedData = normalized;
                return normalized;
            }

            // Vytvoření indexu stránek pro rychlé vyhledávání
            indexPages(data) {
                this.pageIndex.clear();
                
                data.pages.forEach((page, index) => {
                    this.pageIndex.set(page.id, {
                        page: page,
                        index: index
                    });
                });
                
                console.log(`Indexováno ${this.pageIndex.size} stránek`);
            }

            // Přednačtení všech obrázků
            async preloadImages(data) {
                const imageUrls = new Set();

                const pushUrls = (...sources) => {
                    this.collectImageUrls(...sources).forEach(url => imageUrls.add(url));
                };

                // Sbírání všech URL obrázků ze všech zdrojů
                data.pages.forEach(page => {
                    pushUrls(page.background_imgs, page.background_img);
                    pushUrls(page.scene_image);
                    pushUrls(page.ui?.puzzle_img, page.ui?.scene_img);
                    pushUrls(page.ui?.background_imgs, page.ui?.background_img);

                    if (page.elements) {
                        page.elements.forEach(element => {
                            pushUrls(element?.image_url, element?.src, element?.url);
                        });
                    }
                });

                this.showLoading(`Načítám obrázky... (0/${imageUrls.size})`);
                
                const promises = Array.from(imageUrls).map((url, index) => 
                    this.preloadSingleImage(url).then(() => {
                        this.showLoading(`Načítám obrázky... (${index + 1}/${imageUrls.size})`);
                    })
                );
                
                try {
                    await Promise.all(promises);
                    console.log(`Přednačteno ${imageUrls.size} obrázků`);
                } catch (error) {
                    console.warn('Některé obrázky se nepodařilo načíst:', error);
                }
            }

            // Přednačtení jednoho obrázku
            preloadSingleImage(url) {
                return new Promise((resolve, reject) => {
                    if (this.preloadedImages.has(url)) {
                        resolve();
                        return;
                    }
                    
                    const img = new Image();
                    img.crossOrigin = 'anonymous'; // Pokus o CORS
                    img.onload = () => {
                        this.preloadedImages.add(url);
                        console.log(`✅ Obrázek načten: ${url}`);
                        resolve();
                    };
                    img.onerror = () => {
                        console.warn(`❌ Nepodařilo se načíst obrázek: ${url}`);
                        // Přidáme i chybné URL do cache aby se nepokoušelo znovu
                        this.preloadedImages.add(url);
                        resolve(); // Pokračujeme i při chybě
                    };
                    img.src = url;
                });
            }

            // === DÁVKA 12: A11Y & QOL METHODS ===

            // Escapování JSON do data-* atributů
            escapeAttr(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            // Nastavení globální klávesové navigace
            setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // Z - cyklování text zoom
                    if (e.key === 'z' || e.key === 'Z') {
                        e.preventDefault();
                        this.cycleTextSize();
                    }
                    
                    // Enter - potvrzení aktivního zámku
                    if (e.key === 'Enter') {
                        const activeLock = document.querySelector('.lock-container');
                        if (activeLock) {
                            e.preventDefault();
                            this.handleLockEnter(activeLock);
                        }
                    }
                    
                    // Backspace - mazání v numerických zámcích
                    if (e.key === 'Backspace') {
                        const numericLock = document.querySelector('.lock-container[data-config*="numeric"]');
                        if (numericLock && document.activeElement.closest('.lock-container') === numericLock) {
                            e.preventDefault();
                            const lockId = numericLock.id;
                            this.numericBackspace(lockId);
                        }
                    }
                    
                    // Číselné klávesy pro numerické zámky
                    if (/^[0-9]$/.test(e.key)) {
                        const numericLock = document.querySelector('.lock-container[data-config*="numeric"]');
                        if (numericLock && document.activeElement.closest('.lock-container') === numericLock) {
                            e.preventDefault();
                            const lockId = numericLock.id;
                            this.inputNumericKey(lockId, e.key);
                        }
                    }
                });
            }

            // Cyklování velikosti textu klávesou Z
            cycleTextSize() {
                const sizes = ['small', 'medium', 'large', 'xlarge'];
                const currentIndex = sizes.indexOf(this.state.textSize);
                const nextIndex = (currentIndex + 1) % sizes.length;
                const nextSize = sizes[nextIndex];
                
                this.setTextSize(nextSize);
                this.announceToScreenReader(`Velikost textu změněna na ${this.getTextSizeLabel(nextSize)}`);
            }

            // Získání popisku velikosti textu
            getTextSizeLabel(size) {
                const labels = {
                    'small': 'malé písmo',
                    'medium': 'střední písmo', 
                    'large': 'velké písmo',
                    'xlarge': 'extra velké písmo'
                };
                return labels[size] || 'střední písmo';
            }

            // Obsluha Enter klávesy pro zámky
            handleLockEnter(lockElement) {
                const lockId = lockElement.id;
                const config = JSON.parse(lockElement.dataset.config || '{}');
                
                switch (config.mode) {
                    case 'numeric':
                        this.checkNumericLock(lockId);
                        break;
                    case 'text':
                        this.checkTextLock(lockId);
                        break;
                    case 'arrows':
                        this.checkSequenceLock(lockId, 'arrows');
                        break;
                    case 'colors':
                        this.checkSequenceLock(lockId, 'colors');
                        break;
                    case 'shapes':
                        this.checkSequenceLock(lockId, 'shapes');
                        break;
                    case 'cryptex':
                        this.checkCryptexLock(lockId);
                        break;
                    case 'quiz':
                        this.checkQuizLock(lockId);
                        break;
                }
            }

            // Oznámení pro screen readery
            announceToScreenReader(message) {
                if (this.liveRegion) {
                    this.liveRegion.textContent = message;
                    // Vymazání po krátké době aby se mohla znovu použít
                    setTimeout(() => {
                        this.liveRegion.textContent = '';
                    }, 1000);
                }
            }

            // Generování labelu pro progress rail
            progressLabelFor(page, index) {
                if (page?.ui?.progress_label) {
                    return page.ui.progress_label;
                }

                switch (page?.type) {
                    case 'story':
                        return index === 0 ? 'Start' : `Příběh ${index + 1}`;
                    case 'magnifier':
                        return 'Scéna';
                    case 'lock':
                        return 'Zámek';
                    case 'quiz':
                        return 'Kvíz';
                    case 'cryptex':
                        return 'Cryptex';
                    case 'win':
                        return 'Výhra';
                    case 'lose':
                        return 'Prohra';
                    default:
                        return `Krok ${index + 1}`;
                }
            }

            // Generování ikony pro progress rail
            progressIconFor(type, fallback) {
                switch (type) {
                    case 'story':
                        return 'ⓘ';
                    case 'win':
                        return '🏁';
                    case 'lose':
                        return '⏰';
                    default:
                        return fallback;
                }
            }

            // Rozbalování/sbalování sekcí
            toggleSection(domId) {
                const el = document.getElementById(domId);
                if (!el) return;
                el.classList.toggle('collapsed');
            }

            // zap/vyp lupa nad daným <img>
            toggleMagnifier(imageId, config) {
                const key = imageId;
                if (this.magnifiers.has(key)) {
                    this.magnifiers.get(key)?.destroy?.();
                    this.magnifiers.delete(key);
                    this.announceToScreenReader('Lupa vypnuta');
                    return false;
                } else {
                    const img = document.getElementById(imageId);
                    if (!img) return false;
                    const inst = this.useMagnifier(img, config);
                    if (!inst) {
                        this.announceToScreenReader('Lupa není dostupná na tomto zařízení');
                        return false;
                    }
                    this.magnifiers.set(key, inst);
                    this.announceToScreenReader('Lupa zapnuta');
                    return true;
                }
            }

            // === DÁVKA 2: STAV, NAVIGACE, TIMER ===

            // === DÁVKA 4: PROGRESSRAIL + SCENE ===
            // === DÁVKA 5: INFOBUBBLE + TEXT ZOOM ===
            // === DÁVKA 6: MAGNIFIER ===

            // Magnifier funkce
            useMagnifier(imgElement, config = {}) {
                const cfg = { lensSize: 140, zoomLevel: 2, resultSize: 180, ...config };
                const matchMediaSupported = typeof window !== 'undefined' && typeof window.matchMedia === 'function';
                const hasFinePointer = !matchMediaSupported || window.matchMedia('(pointer: fine)').matches;
                const hasHover = !matchMediaSupported || window.matchMedia('(hover: hover)').matches;

                if (!hasFinePointer || !hasHover) {
                    return null;
                }

                const container = imgElement.closest('.magnifier-container') || imgElement.parentElement;
                if (!container) {
                    return null;
                }

                const requestFrame = (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function')
                    ? window.requestAnimationFrame.bind(window)
                    : (cb) => setTimeout(cb, 16);
                const cancelFrame = (typeof window !== 'undefined' && typeof window.cancelAnimationFrame === 'function')
                    ? window.cancelAnimationFrame.bind(window)
                    : (id) => clearTimeout(id);

                const lens = document.createElement('div');
                const result = document.createElement('div');

                lens.className = 'magnifier-lens';
                lens.style.width = cfg.lensSize + 'px';
                lens.style.height = cfg.lensSize + 'px';

                result.className = 'magnifier-result';
                result.style.width = cfg.resultSize + 'px';
                result.style.height = cfg.resultSize + 'px';
                result.style.backgroundImage = `url(${imgElement.src})`;
                result.style.backgroundRepeat = 'no-repeat';

                container.appendChild(lens);
                container.appendChild(result);

                let rafId = null;
                let lastEvent = null;

                const updateLensPosition = () => {
                    rafId = null;
                    if (!lastEvent) return;

                    const rect = imgElement.getBoundingClientRect();
                    const clientX = lastEvent.clientX;
                    const clientY = lastEvent.clientY;

                    if (typeof clientX !== 'number' || typeof clientY !== 'number') {
                        return;
                    }

                    const relativeX = clientX - rect.left;
                    const relativeY = clientY - rect.top;

                    const half = cfg.lensSize / 2;
                    const clamp = (value, min, max) => Math.max(min, Math.min(max, value));

                    // Focus can reach every edge of the artwork
                    const focusX = clamp(relativeX, 0, rect.width);
                    const focusY = clamp(relativeY, 0, rect.height);

                    // Lens chrome stays clamped to valid content
                    const lensLeft = clamp(focusX - half, -half, Math.max(-half, rect.width - half));
                    const lensTop = clamp(focusY - half, -half, Math.max(-half, rect.height - half));

                    lens.style.left = lensLeft + 'px';
                    lens.style.top = lensTop + 'px';

                    const naturalWidth = imgElement.naturalWidth || imgElement.width || rect.width;
                    const naturalHeight = imgElement.naturalHeight || imgElement.height || rect.height;
                    const bgWidth = naturalWidth * cfg.zoomLevel;
                    const bgHeight = naturalHeight * cfg.zoomLevel;
                    result.style.backgroundSize = `${bgWidth}px ${bgHeight}px`;

                    const scaleX = naturalWidth / rect.width;
                    const scaleY = naturalHeight / rect.height;
                    const backgroundX = -(focusX * scaleX * cfg.zoomLevel - cfg.resultSize / 2);
                    const backgroundY = -(focusY * scaleY * cfg.zoomLevel - cfg.resultSize / 2);

                    // Prevent blank space in zoomed preview
                    const minBackgroundX = Math.min(0, cfg.resultSize - bgWidth);
                    const minBackgroundY = Math.min(0, cfg.resultSize - bgHeight);

                    result.style.backgroundPosition = `${clamp(backgroundX, minBackgroundX, 0)}px ${clamp(backgroundY, minBackgroundY, 0)}px`;
                };

                const queuePositionUpdate = (event) => {
                    lastEvent = event;
                    if (rafId === null) {
                        rafId = requestFrame(updateLensPosition);
                    }
                };

                const handleMouseEnter = (event) => {
                    lens.style.display = 'block';
                    result.style.display = 'block';
                    queuePositionUpdate(event);
                };

                const handleMouseMove = (event) => {
                    queuePositionUpdate(event);
                };

                const handleMouseLeave = () => {
                    lens.style.display = 'none';
                    result.style.display = 'none';
                    lastEvent = null;
                };

                container.addEventListener('mouseenter', handleMouseEnter);
                container.addEventListener('mousemove', handleMouseMove);
                container.addEventListener('mouseleave', handleMouseLeave);

                return {
                    destroy: () => {
                        if (rafId !== null) {
                            cancelFrame(rafId);
                            rafId = null;
                        }
                        lastEvent = null;
                        container.removeEventListener('mouseenter', handleMouseEnter);
                        container.removeEventListener('mousemove', handleMouseMove);
                        container.removeEventListener('mouseleave', handleMouseLeave);
                        lens.remove();
                        result.remove();
                    }
                };
            }

            // ZoomableSceneImage komponenta
            createZoomableSceneImage(imageUrl, magnifierConfig = {}) {
                const imageId = 'zoomable-' + Date.now();
                
                return `
                    <div class="magnifier-container">
                        <img id="${imageId}" 
                             src="${imageUrl}" 
                             class="zoomable-scene-image magnifier-image" 
                             alt="Zoomovatelný obrázek scény"
                             onload="game.initMagnifier('${imageId}', ${JSON.stringify(magnifierConfig).replace(/"/g, '&quot;')})">
                    </div>
                `;
            }

            // Inicializace magnifieru pro konkrétní obrázek
            initMagnifier(imageId, config) {
                const imgElement = document.getElementById(imageId);
                if (imgElement && config.enabled) {
                    setTimeout(() => {
                        this.useMagnifier(imgElement, config);
                    }, 100);
                }
            }

            // === DÁVKA 7-9: EVALUATORS + COMPLETE LOCK SYSTEM ===

            // Základní evaluační funkce
            eqText(input, expected, caseSensitive = false) {
                const inputStr = String(input).trim();
                const expectedStr = String(expected).trim();
                
                if (caseSensitive) {
                    return inputStr === expectedStr;
                } else {
                    return inputStr.toLowerCase() === expectedStr.toLowerCase();
                }
            }

            eqSeq(inputArray, expectedArray) {
                if (inputArray.length !== expectedArray.length) return false;
                return inputArray.every((val, idx) => val === expectedArray[idx]);
            }

            posStatus(inputArray, expectedArray) {
                return inputArray.map((val, idx) => {
                    if (val === '' || val === null || val === undefined) return 'empty';
                    return val === expectedArray[idx] ? 'correct' : 'incorrect';
                });
            }

            // Numerický evaluátor
            evalNumeric(inputs, solution) {
                const expected = solution.sequence || [];
                const filled = inputs.filter(v => v !== '' && v !== null && v !== undefined);

                if (filled.length < expected.length) {
                    return {
                        success: false,
                        positions: this.posStatus(inputs, expected.map(String)),
                        feedback: `Zadejte ${expected.length} čísel`
                    };
                }

                const numbers = inputs.map(v => Number(v));
                const ok = this.eqSeq(numbers, expected);
                return {
                    success: ok,
                    positions: this.posStatus(inputs, expected.map(String)),
                    feedback: ok ? 'Správně!' : 'Zkuste to znovu'
                };
            }

            // Textový evaluátor
            evalText(inputs, solution) {
                const text = inputs.join('');
                const expected = solution.word || '';
                const caseSensitive = solution.case_sensitive || false;
                
                return {
                    success: this.eqText(text, expected, caseSensitive),
                    positions: this.posStatus(inputs, expected.split('')),
                    feedback: text.length === expected.length ?
                        (this.eqText(text, expected, caseSensitive) ? 'Správně!' : 'Nesprávné slovo') :
                        `Zadejte ${expected.length} písmen`
                };
            }

            // Šipkový evaluátor
            evalArrows(inputs, solution) {
                const arrows = inputs.filter(val => val !== '' && val !== null && val !== undefined);
                const expected = solution.sequence || [];
                
                return {
                    success: this.eqSeq(arrows, expected),
                    positions: this.posStatus(inputs, expected),
                    feedback: arrows.length === expected.length ?
                        (this.eqSeq(arrows, expected) ? 'Správná sekvence!' : 'Špatné pořadí šipek') :
                        `Zadejte ${expected.length} šipek`
                };
            }

            // Barevný evaluátor
            evalColors(inputs, solution) {
                const colors = inputs.filter(val => val !== '' && val !== null && val !== undefined);
                const expected = solution.sequence || [];
                
                return {
                    success: this.eqSeq(colors, expected),
                    positions: this.posStatus(inputs, expected),
                    feedback: colors.length === expected.length ?
                        (this.eqSeq(colors, expected) ? 'Správné barvy!' : 'Špatná kombinace barev') :
                        `Vyberte ${expected.length} barev`
                };
            }

            // Tvarový evaluátor
            evalShapes(inputs, solution) {
                const shapes = inputs.filter(val => val !== '' && val !== null && val !== undefined);
                const expected = solution.sequence || [];
                
                return {
                    success: this.eqSeq(shapes, expected),
                    positions: this.posStatus(inputs, expected),
                    feedback: shapes.length === expected.length ?
                        (this.eqSeq(shapes, expected) ? 'Správné tvary!' : 'Špatná kombinace tvarů') :
                        `Vyberte ${expected.length} tvarů`
                };
            }

            // Cryptex evaluátor
            evalCryptex(inputs, solution) {
                const word = inputs.join('');
                const expected = solution.word || '';
                const caseSensitive = solution.case_sensitive || false;
                
                return {
                    success: this.eqText(word, expected, caseSensitive),
                    positions: this.posStatus(inputs, expected.split('')),
                    feedback: word.length === expected.length ?
                        (this.eqText(word, expected, caseSensitive) ? 'Cryptex odemčen!' : 'Špatné slovo') :
                        `Nastavte ${expected.length} písmen`
                };
            }

            // Quiz evaluátor
            evalQuiz(selectedAnswer, solution) {
                const correct = solution.correct_answer || 0;
                
                return {
                    success: selectedAnswer === correct,
                    feedback: selectedAnswer === correct ? 
                        'Správná odpověď!' : 
                        `Špatně. Správná odpověď je: ${solution.answers[correct]}`
                };
            }

            // LockRouter - hlavní router pro zámky
            createLockRouter(lockConfig) {
                const mode = lockConfig.mode || 'numeric';
                
                switch (mode) {
                    case 'numeric':
                        return this.createNumericLock(lockConfig);
                    case 'text':
                        return this.createTextLock(lockConfig);
                    case 'arrows':
                        return this.createArrowLock(lockConfig);
                    case 'colors':
                        return this.createColorLock(lockConfig);
                    case 'shapes':
                        return this.createShapeLock(lockConfig);
                    case 'cryptex':
                        return this.createCryptexLock(lockConfig);
                    case 'quiz':
                        return this.createQuizLock(lockConfig);
                    default:
                        return this.createNumericLock(lockConfig);
                }
            }

            // === DÁVKA 8: TEXTLOCK + NUMERICLOCK (plně funkční) ===

            // Textový zámek s UiLabel + UiInput
            createTextLock(config) {
                const solution = config.solution || { word: 'ESCAPE', case_sensitive: false };
                const lockId = 'lock-' + Date.now();
                const caseSensitive = solution.case_sensitive || false;
                
                return `
                    <div class="lock-container" id="${lockId}" data-config='${this.escapeAttr(JSON.stringify(config))}' role="group" aria-labelledby="${lockId}-title">
                        <h3 id="${lockId}-title" class="text-lg font-bold mb-2">🔤 Textový zámek</h3>
                        <p class="text-gray-600 mb-4">${config.hint || 'Zadejte správné slovo'}</p>
                        
                        <div class="ui-field">
                            <label class="ui-label" for="${lockId}-input">
                                Heslo ${caseSensitive ? '(rozlišuje velikost písmen)' : ''} (Enter = potvrdit):
                            </label>
                            <input type="text" 
                                   id="${lockId}-input" 
                                   class="ui-input" 
                                   placeholder="Zadejte heslo..."
                                   aria-describedby="${lockId}-feedback"
                                   onkeypress="game.handleTextLockKeypress(event, '${lockId}')"
                                   oninput="game.updateTextLockState('${lockId}')">
                        </div>
                        
                        <div id="${lockId}-feedback" class="lock-feedback info" style="display: none;" aria-live="polite"></div>
                        
                        <div class="ui-actions">
                            <button onclick="game.checkTextLock('${lockId}')" class="ui-btn primary" aria-describedby="${lockId}-feedback">
                                🔓 Zkontrolovat (Enter)
                            </button>
                            <button onclick="game.resetTextLock('${lockId}')" class="ui-btn secondary">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                `;
            }

            // Numerický zámek se Slots + SoftKeyboard
            createNumericLock(config) {
                const solution = config.solution || { sequence: [1, 2, 3, 4] };
                const inputCount = solution.sequence ? solution.sequence.length : 4;
                const lockId = 'lock-' + Date.now();
                
                console.log('Vytváření číselného zámku:', { solution, inputCount, config });
                
                // Vytvoření slotů
                const slotsHtml = Array.from({ length: inputCount }, (_, i) => 
                    `<div class="numeric-slot" 
                          id="${lockId}-slot-${i}" 
                          onclick="game.selectNumericSlot('${lockId}', ${i})">
                        <span class="slot-content"></span>
                    </div>`
                ).join('');
                
                // Soft keyboard
                const numericKeys = ['1','2','3','4','5','6','7','8','9','0'];
                const numericButtons = numericKeys.map(num => {
                    const extraClass = num === '0' ? ' zero-key' : '';
                    return `<button class="keyboard-key${extraClass}" onclick="game.inputNumericKey('${lockId}', '${num}')" aria-label="Číslo ${num}">${num}</button>`;
                }).join('');

                const keyboardHtml = `
                    <div class="soft-keyboard numeric-keyboard" role="group" aria-label="Číselná klávesnice">
                        <div class="keyboard-grid">
                            ${numericButtons}
                            <button class="keyboard-key backspace-key" onclick="game.numericBackspace('${lockId}')" aria-label="Smazat (Backspace)">⌫</button>
                        </div>
                    </div>
                `;
                
                return `
                    <div class="lock-container" id="${lockId}" data-config='${this.escapeAttr(JSON.stringify(config))}' data-inputs='${this.escapeAttr(JSON.stringify(new Array(inputCount).fill('')))}' data-selected-slot="0" role="group" aria-labelledby="${lockId}-title">
                        <h3 id="${lockId}-title" class="text-lg font-bold mb-2">🔢 Číselný zámek</h3>
                        <p class="text-gray-600 mb-4">${config.hint || 'Zadejte správnou číselnou kombinaci'} (klávesy 0-9, Backspace, Enter)</p>
                        
                        <div class="numeric-slots-container" role="group" aria-label="Číselné pozice">
                            ${slotsHtml}
                        </div>
                        
                        ${keyboardHtml}
                        
                        <div id="${lockId}-feedback" class="lock-feedback info" style="display: none;" aria-live="polite"></div>
                        
                        <div class="ui-actions">
                            <button onclick="game.checkNumericLock('${lockId}')" class="ui-btn primary" aria-describedby="${lockId}-feedback">
                                🔓 Zkontrolovat (Enter)
                            </button>
                            <button onclick="game.resetNumericLock('${lockId}')" class="ui-btn secondary">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                `;
            }

            // === DÁVKA 9: ARROWS / COLORS / SHAPES (sjednocené UI) ===

            // Šipkový zámek
            createArrowLock(config) {
                const solution = config.solution || { sequence: ['↑', '→', '↓', '←'] };
                const inputCount = solution.sequence.length;
                const lockId = 'lock-' + Date.now();
                
                const slotsHtml = Array.from({ length: inputCount }, (_, i) => 
                    `<div class="sequence-slot arrow-slot" 
                          id="${lockId}-slot-${i}" 
                          onclick="game.selectSequenceSlot('${lockId}', ${i})">
                        <span class="slot-content"></span>
                    </div>`
                ).join('');
                
                const keyboardHtml = `
                    <div class="soft-keyboard arrow-keyboard">
                        <div class="keyboard-grid">
                            <button class="keyboard-key arrow-key arrow-up" onclick="game.inputSequenceKey('${lockId}', '↑')">↑</button>
                            <button class="keyboard-key arrow-key arrow-left" onclick="game.inputSequenceKey('${lockId}', '←')">←</button>
                            <button class="keyboard-key arrow-key arrow-right" onclick="game.inputSequenceKey('${lockId}', '→')">→</button>
                            <button class="keyboard-key arrow-key arrow-down" onclick="game.inputSequenceKey('${lockId}', '↓')">↓</button>
                            <button class="keyboard-key backspace-key wide-key" onclick="game.sequenceBackspace('${lockId}')">⌫ Smazat</button>
                        </div>
                    </div>
                `;
                
                return `
                    <div class="lock-container" id="${lockId}" data-config='${this.escapeAttr(JSON.stringify(config))}' data-inputs='${this.escapeAttr(JSON.stringify(new Array(inputCount).fill('')))}' data-selected-slot="0">
                        <h3 class="text-lg font-bold mb-2">🏹 Šipkový zámek</h3>
                        <p class="text-gray-600 mb-4">${config.hint || 'Zadejte správnou sekvenci šipek'}</p>
                        
                        <div class="sequence-slots-container">
                            ${slotsHtml}
                        </div>
                        
                        ${keyboardHtml}
                        
                        <div id="${lockId}-feedback" class="lock-feedback info" style="display: none;"></div>
                        
                        <div class="ui-actions">
                            <button onclick="game.checkSequenceLock('${lockId}', 'arrows')" class="ui-btn primary">
                                🔓 Zkontrolovat
                            </button>
                            <button onclick="game.resetSequenceLock('${lockId}')" class="ui-btn secondary">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                `;
            }

            // Barevný zámek
            createColorLock(config) {
                const solution = config.solution || { sequence: ['red', 'blue', 'green', 'yellow'] };
                const inputCount = solution.sequence.length;
                const lockId = 'lock-' + Date.now();
                const showNames = config.show_names || false;
                
                // Základní barvy
                const defaultColors = {
                    'red': '#ef4444',
                    'blue': '#3b82f6', 
                    'green': '#22c55e',
                    'yellow': '#eab308',
                    'purple': '#a855f7',
                    'orange': '#f97316',
                    'pink': '#ec4899',
                    'cyan': '#06b6d4'
                };
                
                const colors = config.assets?.colors || defaultColors;
                
                const slotsHtml = Array.from({ length: inputCount }, (_, i) => 
                    `<div class="sequence-slot color-slot" 
                          id="${lockId}-slot-${i}" 
                          onclick="game.selectSequenceSlot('${lockId}', ${i})">
                        <div class="color-circle"></div>
                        ${showNames ? '<span class="color-name"></span>' : ''}
                    </div>`
                ).join('');
                
                const colorKeysHtml = Object.entries(colors).map(([name, hex]) => 
                    `<button class="keyboard-key color-key" 
                             onclick="game.inputSequenceKey('${lockId}', '${name}')"
                             style="background-color: ${hex}; border-color: ${hex};">
                        ${showNames ? name : ''}
                    </button>`
                ).join('');
                
                const keyboardHtml = `
                    <div class="soft-keyboard color-keyboard">
                        <div class="keyboard-grid">
                            ${colorKeysHtml}
                            <button class="keyboard-key backspace-key" onclick="game.sequenceBackspace('${lockId}')">⌫</button>
                        </div>
                    </div>
                `;
                
                return `
                    <div class="lock-container" id="${lockId}" data-config='${this.escapeAttr(JSON.stringify(config))}' data-inputs='${this.escapeAttr(JSON.stringify(new Array(inputCount).fill('')))}' data-selected-slot="0" data-colors='${this.escapeAttr(JSON.stringify(colors))}'>
                        <h3 class="text-lg font-bold mb-2">🎨 Barevný zámek</h3>
                        <p class="text-gray-600 mb-4">${config.hint || 'Vyberte správnou kombinaci barev'}</p>
                        
                        <div class="sequence-slots-container">
                            ${slotsHtml}
                        </div>
                        
                        ${keyboardHtml}
                        
                        <div id="${lockId}-feedback" class="lock-feedback info" style="display: none;"></div>
                        
                        <div class="ui-actions">
                            <button onclick="game.checkSequenceLock('${lockId}', 'colors')" class="ui-btn primary">
                                🔓 Zkontrolovat
                            </button>
                            <button onclick="game.resetSequenceLock('${lockId}')" class="ui-btn secondary">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                `;
            }

            // Tvarový zámek
            createShapeLock(config) {
                const solution = config.solution || { sequence: ['circle', 'square', 'triangle', 'star'] };
                const inputCount = solution.sequence.length;
                const lockId = 'lock-' + Date.now();
                
                // Základní SVG tvary
                const defaultShapes = {
                    'circle': '<circle cx="12" cy="12" r="8" fill="currentColor"/>',
                    'square': '<rect x="4" y="4" width="16" height="16" fill="currentColor"/>',
                    'triangle': '<polygon points="12,4 20,20 4,20" fill="currentColor"/>',
                    'star': '<polygon points="12,2 15,8 22,8 17,13 19,20 12,16 5,20 7,13 2,8 9,8" fill="currentColor"/>',
                    'diamond': '<polygon points="12,2 22,12 12,22 2,12" fill="currentColor"/>',
                    'heart': '<path d="M12,21.35l-1.45-1.32C5.4,15.36,2,12.28,2,8.5 2,5.42,4.42,3,7.5,3c1.74,0,3.41,0.81,4.5,2.09C13.09,3.81,14.76,3,16.5,3 C19.58,3,22,5.42,22,8.5c0,3.78-3.4,6.86-8.55,11.54L12,21.35z" fill="currentColor"/>'
                };
                
                const shapes = config.assets?.shape_svgs || defaultShapes;
                
                const slotsHtml = Array.from({ length: inputCount }, (_, i) => 
                    `<div class="sequence-slot shape-slot" 
                          id="${lockId}-slot-${i}" 
                          onclick="game.selectSequenceSlot('${lockId}', ${i})">
                        <div class="shape-container"></div>
                    </div>`
                ).join('');
                
                const shapeKeysHtml = Object.entries(shapes).map(([name, svg]) => 
                    `<button class="keyboard-key shape-key" 
                             onclick="game.inputSequenceKey('${lockId}', '${name}')"
                             title="${name}">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            ${svg}
                        </svg>
                    </button>`
                ).join('');
                
                const keyboardHtml = `
                    <div class="soft-keyboard shape-keyboard">
                        <div class="keyboard-grid">
                            ${shapeKeysHtml}
                            <button class="keyboard-key backspace-key" onclick="game.sequenceBackspace('${lockId}')">⌫</button>
                        </div>
                    </div>
                `;
                
                return `
                    <div class="lock-container" id="${lockId}" data-config='${this.escapeAttr(JSON.stringify(config))}' data-inputs='${this.escapeAttr(JSON.stringify(new Array(inputCount).fill('')))}' data-selected-slot="0" data-shapes='${this.escapeAttr(JSON.stringify(shapes))}'>
                        <h3 class="text-lg font-bold mb-2">🔷 Tvarový zámek</h3>
                        <p class="text-gray-600 mb-4">${config.hint || 'Vyberte správnou kombinaci tvarů'}</p>
                        
                        <div class="sequence-slots-container">
                            ${slotsHtml}
                        </div>
                        
                        ${keyboardHtml}
                        
                        <div id="${lockId}-feedback" class="lock-feedback info" style="display: none;"></div>
                        
                        <div class="ui-actions">
                            <button onclick="game.checkSequenceLock('${lockId}', 'shapes')" class="ui-btn primary">
                                🔓 Zkontrolovat
                            </button>
                            <button onclick="game.resetSequenceLock('${lockId}')" class="ui-btn secondary">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                `;
            }

            // Cryptex zámek s otáčivými kolečky
            createCryptexLock(config) {
                const solution = config.solution || { word: 'ESCAPE', case_sensitive: false };
                const inputCount = solution.word.length;
                const lockId = 'lock-' + Date.now();
                
                // Základní sady znaků pro kolečka
                const defaultWheels = Array.from({ length: inputCount }, () => 
                    'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('')
                );
                
                const wheels = config.assets?.keyboards?.cryptex?.wheels || defaultWheels;
                
                // Vytvoření sloupců s kolečky
                const columnsHtml = Array.from({ length: inputCount }, (_, i) => {
                    const wheelChars = wheels[i] || wheels[0] || 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                    const startIndex = 0;
                    
                    return `
                        <div class="cryptex-column" data-wheel-index="${i}" data-current-index="${startIndex}">
                            <button class="cryptex-arrow cryptex-up" onclick="game.rotateCryptexWheel('${lockId}', ${i}, -1)">↑</button>
                            <div class="cryptex-wheel">
                                <div class="cryptex-char" id="${lockId}-char-${i}">${wheelChars[startIndex]}</div>
                            </div>
                            <button class="cryptex-arrow cryptex-down" onclick="game.rotateCryptexWheel('${lockId}', ${i}, 1)">↓</button>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="lock-container cryptex-container" id="${lockId}" data-config='${this.escapeAttr(JSON.stringify(config))}' data-wheels='${this.escapeAttr(JSON.stringify(wheels))}' data-positions='${this.escapeAttr(JSON.stringify(new Array(inputCount).fill(0)))}'>
                        <h3 class="text-lg font-bold mb-2">🗝️ Cryptex</h3>
                        <p class="text-gray-600 mb-4">${config.hint || 'Otáčejte kolečka pro nastavení správného slova'}</p>
                        
                        <div class="cryptex-wheels-container">
                            ${columnsHtml}
                        </div>
                        
                        <div id="${lockId}-feedback" class="lock-feedback info" style="display: none;"></div>
                        
                        <div class="ui-actions">
                            <button onclick="game.checkCryptexLock('${lockId}')" class="ui-btn primary">
                                🔓 Zkontrolovat
                            </button>
                            <button onclick="game.resetCryptexLock('${lockId}')" class="ui-btn secondary">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                `;
            }

            // Quiz zámek s náhodnými otázkami
            createQuizLock(config) {
                const lockId = 'lock-' + Date.now();
                const questions = config.questions || [
                    {
                        question: "Jaká je hlavní barva oblohy?",
                        answers: ["Červená", "Modrá", "Zelená", "Žlutá"],
                        correct_answer: 1
                    }
                ];
                
                const minRatio = config.min_ratio || config.pass_ratio || 0.8;
                const drawLimit = config.limit_draw || Math.min(5, questions.length);
                
                // Náhodný výběr otázek
                const shuffledQuestions = [...questions].sort(() => Math.random() - 0.5);
                const selectedQuestions = shuffledQuestions.slice(0, drawLimit);
                
                const questionsHtml = selectedQuestions.map((q, index) => {
                    const answersHtml = q.answers.map((answer, answerIndex) => 
                        `<label class="quiz-answer">
                            <input type="radio" name="${lockId}-q${index}" value="${answerIndex}" onchange="game.updateQuizProgress('${lockId}')">
                            <span class="quiz-answer-text">${answer}</span>
                        </label>`
                    ).join('');
                    
                    return `
                        <div class="quiz-question" data-question-index="${index}" data-correct="${q.correct_answer}">
                            <h4 class="quiz-question-text">${index + 1}. ${q.question}</h4>
                            <div class="quiz-answers">
                                ${answersHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="lock-container quiz-container" id="${lockId}" data-config='${this.escapeAttr(JSON.stringify(config))}' data-questions='${this.escapeAttr(JSON.stringify(selectedQuestions))}' data-min-ratio="${minRatio}">
                        <h3 class="text-lg font-bold mb-2">❓ Vědomostní test</h3>
                        <p class="text-gray-600 mb-4">${config.hint || `Odpovězte správně na alespoň ${Math.ceil(selectedQuestions.length * minRatio)} z ${selectedQuestions.length} otázek`}</p>
                        
                        <div class="quiz-progress mb-4">
                            <div class="quiz-progress-bar">
                                <div class="quiz-progress-fill" id="${lockId}-progress" style="width: 0%"></div>
                            </div>
                            <div class="quiz-progress-text" id="${lockId}-progress-text">0 / ${selectedQuestions.length} odpovězeno</div>
                        </div>
                        
                        <div class="quiz-questions">
                            ${questionsHtml}
                        </div>
                        
                        <div id="${lockId}-feedback" class="lock-feedback info" style="display: none;"></div>
                        
                        <div class="ui-actions">
                            <button onclick="game.checkQuizLock('${lockId}')" class="ui-btn primary" id="${lockId}-submit" disabled>
                                ✓ Odevzdat odpovědi
                            </button>
                            <button onclick="game.resetQuizLock('${lockId}')" class="ui-btn secondary">
                                🔄 Začít znovu
                            </button>
                        </div>
                    </div>
                `;
            }

            // === DÁVKA 8: TEXT LOCK METHODS ===

            // Obsluha klávesy Enter pro textový zámek
            handleTextLockKeypress(event, lockId) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.checkTextLock(lockId);
                }
            }

            // Aktualizace stavu textového zámku
            updateTextLockState(lockId) {
                const input = document.getElementById(lockId + '-input');
                const feedbackElement = document.getElementById(lockId + '-feedback');
                
                if (input && feedbackElement) {
                    // Skrytí zpětné vazby při psaní
                    feedbackElement.style.display = 'none';
                    
                    // Odstranění stavových tříd
                    input.classList.remove('correct', 'incorrect');
                }
            }

            // Kontrola textového zámku
            checkTextLock(lockId) {
                const lockElement = document.getElementById(lockId);
                const input = document.getElementById(lockId + '-input');
                if (!lockElement || !input) return;
                
                const config = JSON.parse(lockElement.dataset.config);
                const inputValue = input.value;
                const inputArray = inputValue.split('');
                
                const result = this.evalText(inputArray, config.solution);
                this.showLockFeedback(lockId, result);
                
                // Vizuální zpětná vazba na input
                input.classList.remove('correct', 'incorrect');
                input.classList.add(result.success ? 'correct' : 'incorrect');
                
                if (result.success) {
                    setTimeout(() => {
                        this.onResolve(this.state.currentId, true);
                    }, 1500);
                }
            }

            // Reset textového zámku
            resetTextLock(lockId) {
                const input = document.getElementById(lockId + '-input');
                const feedbackElement = document.getElementById(lockId + '-feedback');
                
                if (input) {
                    input.value = '';
                    input.classList.remove('correct', 'incorrect');
                }
                
                if (feedbackElement) {
                    feedbackElement.style.display = 'none';
                }
            }

            // === DÁVKA 8: NUMERIC LOCK METHODS ===

            // Výběr numerického slotu
            selectNumericSlot(lockId, slotIndex) {
                const lockElement = document.getElementById(lockId);
                if (!lockElement) return;
                
                // Odstranění selected třídy ze všech slotů
                lockElement.querySelectorAll('.numeric-slot').forEach(slot => {
                    slot.classList.remove('selected');
                });
                
                // Přidání selected třídy k vybranému slotu
                const selectedSlot = document.getElementById(`${lockId}-slot-${slotIndex}`);
                if (selectedSlot) {
                    selectedSlot.classList.add('selected');
                }
                
                // Uložení vybraného slotu
                lockElement.dataset.selectedSlot = slotIndex;
            }

            // Vstup číslice do numerického zámku
            inputNumericKey(lockId, digit) {
                const lockElement = document.getElementById(lockId);
                if (!lockElement) return;
                
                const selectedSlot = parseInt(lockElement.dataset.selectedSlot || '0');
                const inputs = JSON.parse(lockElement.dataset.inputs || '[]');
                
                // Nastavení hodnoty do vybraného slotu
                inputs[selectedSlot] = digit;
                lockElement.dataset.inputs = JSON.stringify(inputs);
                
                // Aktualizace zobrazení slotu
                const slotElement = document.getElementById(`${lockId}-slot-${selectedSlot}`);
                if (slotElement) {
                    const content = slotElement.querySelector('.slot-content');
                    if (content) {
                        content.textContent = digit;
                    }
                }
                
                // Automatický přechod na další slot
                const nextSlot = selectedSlot + 1;
                if (nextSlot < inputs.length) {
                    this.selectNumericSlot(lockId, nextSlot);
                }
                
                // Skrytí zpětné vazby
                const feedbackElement = document.getElementById(lockId + '-feedback');
                if (feedbackElement) {
                    feedbackElement.style.display = 'none';
                }
            }

            // Backspace pro numerický zámek
            numericBackspace(lockId) {
                const lockElement = document.getElementById(lockId);
                if (!lockElement) return;
                
                const selectedSlot = parseInt(lockElement.dataset.selectedSlot || '0');
                const inputs = JSON.parse(lockElement.dataset.inputs || '[]');
                
                // Vymazání aktuálního slotu nebo přechod na předchozí
                if (inputs[selectedSlot] !== '') {
                    inputs[selectedSlot] = '';
                } else if (selectedSlot > 0) {
                    inputs[selectedSlot - 1] = '';
                    this.selectNumericSlot(lockId, selectedSlot - 1);
                }
                
                lockElement.dataset.inputs = JSON.stringify(inputs);
                
                // Aktualizace zobrazení
                this.updateNumericSlotsDisplay(lockId, inputs);
                
                // Skrytí zpětné vazby
                const feedbackElement = document.getElementById(lockId + '-feedback');
                if (feedbackElement) {
                    feedbackElement.style.display = 'none';
                }
            }

            // Aktualizace zobrazení numerických slotů
            updateNumericSlotsDisplay(lockId, inputs) {
                inputs.forEach((value, index) => {
                    const slotElement = document.getElementById(`${lockId}-slot-${index}`);
                    if (slotElement) {
                        const content = slotElement.querySelector('.slot-content');
                        if (content) {
                            content.textContent = value || '';
                        }
                        // Odstranění stavových tříd
                        slotElement.classList.remove('correct', 'incorrect');
                    }
                });
            }

            // Kontrola numerického zámku
            checkNumericLock(lockId) {
                const lockElement = document.getElementById(lockId);
                if (!lockElement) return;
                
                const config = JSON.parse(lockElement.dataset.config);
                const inputs = JSON.parse(lockElement.dataset.inputs || '[]');
                
                const result = this.evalNumeric(inputs, config.solution);
                this.showLockFeedback(lockId, result);
                
                // Vizuální zpětná vazba na sloty
                if (result.positions) {
                    result.positions.forEach((status, index) => {
                        const slot = document.getElementById(`${lockId}-slot-${index}`);
                        if (slot) {
                            slot.classList.remove('correct', 'incorrect');
                            if (status === 'correct') slot.classList.add('correct');
                            if (status === 'incorrect') slot.classList.add('incorrect');
                        }
                    });
                }
                
                if (result.success) {
                    setTimeout(() => {
                        this.onResolve(this.state.currentId, true);
                    }, 1500);
                }
            }

            // Reset numerického zámku
            resetNumericLock(lockId) {
                const lockElement = document.getElementById(lockId);
                if (!lockElement) return;
                
                const config = JSON.parse(lockElement.dataset.config);
                const inputCount = config.solution.sequence.length;
                const emptyInputs = new Array(inputCount).fill('');
                
                lockElement.dataset.inputs = JSON.stringify(emptyInputs);
                lockElement.dataset.selectedSlot = '0';
                
                this.updateNumericSlotsDisplay(lockId, emptyInputs);
                this.selectNumericSlot(lockId, 0);
                
                const feedbackElement = document.getElementById(lockId + '-feedback');
                if (feedbackElement) {
                    feedbackElement.style.display = 'none';
                }
            }

            // === DÁVKA 9: SEQUENCE LOCK METHODS (Arrows, Colors, Shapes) ===

            // Výběr slotu v sekvenci
            selectSequenceSlot(lockId, slotIndex) {
                const lockElement = document.getElementById(lockId);
                if (!lockElement) return;
                
                // Odstranění selected třídy ze všech slotů
                lockElement.querySelectorAll('.sequence-slot').forEach(slot => {
                    slot.classList.remove('selected');
                });
                
                // Přidání selected třídy k vybranému slotu
                const selectedSlot = document.getElementById(`${lockId}-slot-${slotIndex}`);
                if (selectedSlot) {
                    selectedSlot.classList.add('selected');
                }
                
                // Uložení vybraného slotu
                lockElement.dataset.selectedSlot = slotIndex;
            }

            // Vstup hodnoty do sekvence
            inputSequenceKey(lockId, value) {
                const lockElement = document.getElementById(lockId);
                if (!lockElement) return;
                <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9912b932f5bfbb9c',t:'MTc2MDkwMjU3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
